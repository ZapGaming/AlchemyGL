<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISOTOPE | Virtual Chemistry Lab</title>
    <link rel="stylesheet" href="style.css">
    
    <script type="importmap">
    { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>
</head>
<body>

    <!-- LAYER 1: 3D VIEWPORT -->
    <div id="isotope-viewport"></div>

    <!-- LAYER 2: INTERFACE -->
    <main class="lab-container">
        
        <header>
            <div class="lab-brand">ISOTOPE<div class="sup">EDU</div></div>
            <div class="subtitle">Volumetric Simulation Environment v7</div>
        </header>

        <div class="grid-layout">
            
            <!-- CONTROLS -->
            <section class="panel control-panel">
                <h3>REAGENTS SHELF</h3>
                <div class="reagent-grid">
                    <button class="beaker blue" onclick="setR('H2O2', 'Hydrogen Peroxide')">H₂O₂</button>
                    <button class="beaker yellow" onclick="setR('KI', 'Potassium Iodide')">KI</button>
                    <button class="beaker white" onclick="setR('PB', 'Lead Nitrate')">Pb(NO₃)₂</button>
                    <button class="beaker purple" onclick="setR('C8H7N3O2', 'Luminol')">Luminol</button>
                    <button class="beaker osc" onclick="setR('OSC', 'Iodine Oscillator')">Briggs Cycle</button>
                    <button class="beaker clear" onclick="clearLab()">Water (H₂O)</button>
                </div>

                <div class="mixer-slot">
                    <div class="slot" id="slot1">Empty</div>
                    <div class="plus">+</div>
                    <div class="slot" id="slot2">Empty</div>
                </div>

                <button class="react-btn" onclick="react()">TITRATE / REACT</button>
            </section>

            <!-- NOTEBOOK / OUTPUT -->
            <section class="panel notebook">
                <h3>LABORATORY NOTES</h3>
                
                <div class="data-row">
                    <span class="label">REACTION:</span>
                    <span class="value title" id="res-name">--</span>
                </div>
                
                <div class="equation-box" id="res-eq">
                    A + B → AB
                </div>

                <div class="data-row">
                    <span class="label">ENTHALPY (ΔH):</span>
                    <span class="value" id="res-ent">--</span>
                </div>

                <div class="desc-box">
                    Observation log: Select two reagents from the left to simulate Volumetric Thermodynamics. Real-time Beer's law rendering active.
                </div>
            </section>
        </div>
        
    </main>

    <script type="module">
        import IsotopeEngine from './js/IsotopeGraphics.js';
        
        // 1. Init
        const engine = new IsotopeEngine('isotope-viewport');
        
        // State
        window.state = { r1: null, r2: null, r1ID: null, r2ID: null };

        window.setR = (id, name) => {
            if(!window.state.r1ID) {
                window.state.r1ID = id; window.state.r1 = name;
                document.getElementById('slot1').innerText = id;
                document.getElementById('slot1').classList.add('filled');
            } else if(!window.state.r2ID) {
                window.state.r2ID = id; window.state.r2 = name;
                document.getElementById('slot2').innerText = id;
                document.getElementById('slot2').classList.add('filled');
            } else {
                alert("Beakers full. Clear lab first.");
            }
        };

        window.clearLab = () => {
            window.state = { r1: null, r2: null, r1ID: null, r2ID: null };
            document.querySelectorAll('.slot').forEach(s => {
                s.innerText = "Empty"; s.classList.remove('filled');
            });
            document.getElementById('res-eq').innerText = "System Reset";
            engine.processReaction({ visuals: { baseColor: [0.8,0.9,1.0], secondaryColor:[0.8,0.9,1.0], type:'LIQUID' }});
        }

        window.react = async () => {
            if(!window.state.r1ID) return;
            
            // Only one Reagent? assume water mix or self reaction handling
            const A = window.state.r1ID;
            const B = window.state.r2ID || 'H2O'; // Default water dilution

            // Call Server Math
            const req = await fetch('/api/analyze', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ reactantA: A, reactantB: B })
            });
            const data = await req.json();

            // Update UI
            document.getElementById('res-name').innerText = data.name;
            document.getElementById('res-eq').innerText = data.equation;
            document.getElementById('res-ent').innerText = data.enthalpy;

            // Trigger Engine
            engine.processReaction(data);
        };
    </script>
</body>
</html>
